# Delta Update Server for Open Balena

Open source delta update server for [openbalena](https://github.com/balena-io/open-balena), a platform to deploy and manage connected devices.

## Features
The goal of this project is to faciliate delta image updates, which result in significantly less traffic to devices when downloading images from your `open-balena` servers.  Traditional updates result in devices re-downloading all layers after the point where a change is made in the dockerfile, even if those subsequent layers have not changed.  Delta updates utilize balena-engine (v3) or rsync (v2) to do a binary compare of the image, and only result in downloading of the changed data relative to the image already installed on a device.

## Compatibility
This project is compatible with `open-balena` and specifically relies on the `open-balena-registry` component.  

## Installation

`open-balena-delta` is meant to be installed as part of `open-balena`, and ideally at the same time.  For thoes running `open-balena` on k8s, we have included services to build it in the [open-balena helm project](https://github.com/dcaputo-harmoni/open-balena-helm). If you are running `open-balena` via docker-compose, you will need to modify the scripts to mirror the setup in the helm charts or recreate it using the configuration steps below.

To configure `open-balena-delta` you must define four environment variables and two volumes for the container:

Environment Variables:

- **BALENA_TLD**: `open-balena` base hostname i.e. openbalena.<yourdomain.com>
- **REGISTRY_HOST**: `open-balena-registry` hostmame, i.e. registry.openbalena.<yourdomain.com>
- **DOCKER_HOST**: You likely want to set this to "unix:///var/run/docker.sock"
- **DOCKER_BUILDKIT**: You likely want to set this to "0"
- **TOKEN_AUTH_BUILDER_TOKEN**: The master builder token which was generated by the qucikstart script when you installed `open-balena`

Volumes:

- **/var/lib/balena-engine**: This volume is needed to support overlay2 file system in a container
- **/delta-rsync**: This volume is needed to store rsync deltas, which are necessary if using v2 deltas

You will also need to set up a new hostname for your `open-balena-delta` instance, which likely will just be mapped to your `open-balena` haproxy instance, assuming you used the helm script or otherwise integrated it with your docker-compose scripts.

Hostnames:

- **delta.<yourdomain.com>**: IP address / hostname of `open-balena-haproxy`

## Limitations and Known Issues
- Token authentication still needs to be implemented

## Credits

- Major kudos to the balena team for developing [balena-engine](https://github.com/balena-os/balena-engine), an amazing tool that improves on docker specifically for embedded and IoT use cases
